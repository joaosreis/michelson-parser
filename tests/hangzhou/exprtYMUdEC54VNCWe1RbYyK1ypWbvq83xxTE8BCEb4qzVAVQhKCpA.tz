{ parameter
    (list (pair (address %fa2_address) (list %fa2_batch (pair (nat %token_id) (nat %amount))))) ;
  storage
    (pair (pair %in_currency (address %fa2_address) (nat %token_id))
          (pair (pair %out_currency (address %fa2_address) (nat %token_id))
                (map %price_map address nat))) ;
  code { LAMBDA
           (pair bool string)
           unit
           { UNPAIR ; NOT ; IF { FAILWITH } { DROP ; UNIT } } ;
         LAMBDA
           (list (pair address (list (pair nat nat))))
           nat
           { PUSH nat 0 ; SWAP ; ITER { CDR ; SIZE ; ADD } } ;
         LAMBDA
           address
           (contract (list (pair address (list (pair address (pair nat nat))))))
           { CONTRACT %transfer
               (list (pair (address %from_)
                           (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
             IF_NONE { PUSH string "Invalid FA2 Address" ; FAILWITH } {} } ;
         DUP ;
         LAMBDA
           (pair (lambda address (contract (list (pair address (list (pair address (pair nat nat)))))))
                 (pair address (pair address (pair address (list (pair nat nat))))))
           operation
           { UNPAIR ;
             SWAP ;
             UNPAIR 3 ;
             DUP 3 ;
             CDR ;
             MAP { DUP 3 ; PAIR } ;
             DIG 2 ;
             DROP ;
             DIG 2 ;
             CAR ;
             DIG 3 ;
             SWAP ;
             EXEC ;
             PUSH mutez 0 ;
             NIL (pair address (list (pair address (pair nat nat)))) ;
             DIG 3 ;
             DIG 4 ;
             PAIR ;
             CONS ;
             TRANSFER_TOKENS } ;
         SWAP ;
         APPLY ;
         DIG 4 ;
         UNPAIR ;
         PUSH string "Amount must be 0mutez" ;
         PUSH mutez 0 ;
         AMOUNT ;
         COMPARE ;
         EQ ;
         PAIR ;
         DUP 7 ;
         SWAP ;
         EXEC ;
         DROP ;
         PUSH string "no_taco" ;
         PUSH nat 0 ;
         DUP 3 ;
         DUP 8 ;
         SWAP ;
         EXEC ;
         COMPARE ;
         GT ;
         PAIR ;
         DIG 6 ;
         SWAP ;
         EXEC ;
         DROP ;
         SWAP ;
         DUP ;
         DUG 2 ;
         SELF_ADDRESS ;
         PAIR ;
         SENDER ;
         DUP 3 ;
         DIG 2 ;
         UNPAIR ;
         DIG 2 ;
         MAP { DUP 3 ;
               PAIR ;
               SWAP ;
               DUP ;
               DUG 2 ;
               PAIR ;
               DUP 4 ;
               PAIR ;
               UNPAIR 4 ;
               DIG 2 ;
               CDR ;
               CDR ;
               DUP 4 ;
               CAR ;
               GET ;
               IF_NONE { PUSH string "InvalidFA2" ; FAILWITH } { DROP } ;
               DUP 3 ;
               CDR ;
               MAP { DUP 3 ; PAIR } ;
               DIG 2 ;
               DROP ;
               DIG 2 ;
               CAR ;
               DUP 10 ;
               SWAP ;
               EXEC ;
               PUSH mutez 0 ;
               NIL (pair address (list (pair address (pair nat nat)))) ;
               DIG 3 ;
               DIG 4 ;
               PAIR ;
               CONS ;
               TRANSFER_TOKENS } ;
         SWAP ;
         DROP ;
         SWAP ;
         DROP ;
         SWAP ;
         DROP ;
         DIG 4 ;
         DROP ;
         DUP 3 ;
         SELF_ADDRESS ;
         PAIR ;
         SENDER ;
         DUP 4 ;
         DIG 2 ;
         UNPAIR ;
         SWAP ;
         DUP ;
         DUG 2 ;
         CDR ;
         CDR ;
         DIG 3 ;
         PUSH nat 0 ;
         SWAP ;
         ITER { SWAP ;
                DUP 3 ;
                DUP 3 ;
                CAR ;
                GET ;
                IF_NONE { PUSH string "InvalidFA2" ; FAILWITH } {} ;
                DIG 2 ;
                CDR ;
                SIZE ;
                MUL ;
                ADD } ;
         SWAP ;
         DROP ;
         NIL (pair nat nat) ;
         SWAP ;
         DUP 4 ;
         CAR ;
         CDR ;
         PAIR ;
         CONS ;
         DIG 2 ;
         CAR ;
         CAR ;
         PAIR ;
         SWAP ;
         PAIR ;
         SWAP ;
         PAIR ;
         DUP 5 ;
         SWAP ;
         EXEC ;
         DUP 4 ;
         SENDER ;
         PAIR ;
         SELF_ADDRESS ;
         DIG 4 ;
         DIG 2 ;
         UNPAIR ;
         DIG 2 ;
         DIG 8 ;
         SWAP ;
         EXEC ;
         NIL (pair nat nat) ;
         SWAP ;
         DUP 4 ;
         CDR ;
         CAR ;
         CDR ;
         PAIR ;
         CONS ;
         DIG 2 ;
         CDR ;
         CAR ;
         CAR ;
         PAIR ;
         SWAP ;
         PAIR ;
         SWAP ;
         PAIR ;
         DIG 4 ;
         SWAP ;
         EXEC ;
         DUG 3 ;
         CONS ;
         DIG 2 ;
         CONS ;
         PAIR } }
