{ parameter (pair address nat) ;
  storage
    (pair (pair %bid_currency (address %fa2_address) (nat %token_id))
          (pair (map %vote_ledger (pair address nat) nat)
                (pair (nat %price_to_promo)
                      (pair (nat %current_vote_cycle)
                            (pair (int %time_between_cycles) (timestamp %cycle_end_time)))))) ;
  code { UNPAIR ;
         PUSH string "Amount must be 0mutez" ;
         PUSH mutez 0 ;
         AMOUNT ;
         COMPARE ;
         EQ ;
         NOT ;
         IF { FAILWITH } { DROP } ;
         SWAP ;
         DUP ;
         DUG 2 ;
         CDR ;
         CDR ;
         CDR ;
         CDR ;
         CDR ;
         NOW ;
         COMPARE ;
         GT ;
         IF { SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              CDR ;
              EMPTY_MAP (pair address nat) nat ;
              PAIR ;
              DIG 2 ;
              DUP ;
              DUG 3 ;
              CAR ;
              PAIR ;
              DUP ;
              CDR ;
              CDR ;
              CDR ;
              CDR ;
              PUSH nat 1 ;
              DIG 4 ;
              DUP ;
              DUG 5 ;
              CDR ;
              CDR ;
              CDR ;
              CAR ;
              ADD ;
              PAIR ;
              SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              CDR ;
              CAR ;
              PAIR ;
              SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              CAR ;
              PAIR ;
              SWAP ;
              CAR ;
              PAIR ;
              DIG 2 ;
              CDR ;
              CDR ;
              CDR ;
              CDR ;
              CAR ;
              NOW ;
              ADD ;
              SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              CDR ;
              CDR ;
              CDR ;
              CAR ;
              PAIR ;
              SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              CDR ;
              CDR ;
              CAR ;
              PAIR ;
              SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              CDR ;
              CAR ;
              PAIR ;
              SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              CAR ;
              PAIR ;
              SWAP ;
              CAR ;
              PAIR }
            { SWAP } ;
         DUP ;
         CAR ;
         SWAP ;
         DUP ;
         DUG 2 ;
         CDR ;
         CDR ;
         CAR ;
         PAIR ;
         SELF_ADDRESS ;
         SENDER ;
         DIG 2 ;
         UNPAIR ;
         NIL (pair nat nat) ;
         SWAP ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         CDR ;
         PAIR ;
         CONS ;
         SWAP ;
         CAR ;
         PAIR ;
         DIG 2 ;
         PUSH address "KT19ovJhcsUn4YU8Q5L3BGovKSixfbWcecEA" ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         CAR ;
         COMPARE ;
         EQ ;
         IF { SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              MAP { SWAP ; DUP ; DUG 2 ; PAIR } ;
              SWAP ;
              DROP ;
              SWAP ;
              CAR ;
              CONTRACT %transfer
                (list (pair (address %from_)
                            (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
              IF_NONE { PUSH string "Invalid FA2 Address" ; FAILWITH } {} ;
              PUSH mutez 0 ;
              NIL (pair address (list (pair address (pair nat nat)))) ;
              DIG 3 ;
              DIG 4 ;
              PAIR ;
              CONS ;
              TRANSFER_TOKENS }
            { DROP 3 ; PUSH string "WRONG_CONTRACT" ; FAILWITH } ;
         SWAP ;
         DUP ;
         DUG 2 ;
         CDR ;
         CAR ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         CDR ;
         CDR ;
         CAR ;
         DIG 3 ;
         DUP ;
         DUG 4 ;
         DIG 5 ;
         DUP ;
         DUG 6 ;
         SWAP ;
         CDR ;
         CAR ;
         SWAP ;
         GET ;
         IF_NONE { PUSH nat 0 } {} ;
         ADD ;
         SOME ;
         DIG 4 ;
         UPDATE ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         CDR ;
         CDR ;
         SWAP ;
         PAIR ;
         DIG 2 ;
         CAR ;
         PAIR ;
         NIL operation ;
         DIG 2 ;
         CONS ;
         PAIR } }
