{ parameter
    (list (pair (address %fa2_address) (list %fa2_batch (pair (nat %token_id) (nat %amount))))) ;
  storage
    (pair (pair %bid_currency (address %fa2_address) (nat %token_id))
          (pair (nat %salsa_out) (nat %salsa_in))) ;
  code { LAMBDA
           address
           (contract (list (pair address (list (pair address (pair nat nat))))))
           { CONTRACT %transfer
               (list (pair (address %from_)
                           (list %txs (pair (address %to_) (pair (nat %token_id) (nat %amount)))))) ;
             IF_NONE { PUSH string "Invalid FA2 Address" ; FAILWITH } {} } ;
         SWAP ;
         UNPAIR ;
         PUSH string "Amount must be 0mutez" ;
         PUSH mutez 0 ;
         AMOUNT ;
         COMPARE ;
         EQ ;
         NOT ;
         IF { FAILWITH } { DROP } ;
         SELF_ADDRESS ;
         SENDER ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         MAP { DIG 2 ;
               DUP ;
               DUG 3 ;
               DIG 2 ;
               DUP ;
               DUG 3 ;
               DIG 7 ;
               DUP ;
               DUG 8 ;
               DUG 2 ;
               PAIR ;
               PAIR ;
               LAMBDA
                 (pair (pair (pair address address)
                             (lambda address (contract (list (pair address (list (pair address (pair nat nat))))))))
                       (pair address (list (pair nat nat))))
                 operation
                 { DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   DUP ;
                   CDR ;
                   SWAP ;
                   CAR ;
                   DIG 3 ;
                   PUSH address "KT1UmxSSUQ5716tRa2RLNSAkiSG6TWbzZ7GL" ;
                   SWAP ;
                   DUP ;
                   DUG 2 ;
                   CAR ;
                   COMPARE ;
                   EQ ;
                   PUSH address "KT1LhNu3v6rCa3Ura3bompAAJZD9io5VRaWZ" ;
                   DIG 2 ;
                   DUP ;
                   DUG 3 ;
                   CAR ;
                   COMPARE ;
                   EQ ;
                   OR ;
                   IF { DUP ;
                        CDR ;
                        MAP { DIG 3 ; DUP ; DUG 4 ; PAIR } ;
                        DIG 3 ;
                        DROP ;
                        SWAP ;
                        CAR ;
                        DIG 3 ;
                        SWAP ;
                        EXEC ;
                        PUSH mutez 0 ;
                        NIL (pair address (list (pair address (pair nat nat)))) ;
                        DIG 3 ;
                        DIG 4 ;
                        PAIR ;
                        CONS ;
                        TRANSFER_TOKENS }
                      { DROP 4 ; PUSH string "WRONG_CONTRACT" ; FAILWITH } } ;
               SWAP ;
               APPLY ;
               SWAP ;
               EXEC } ;
         SWAP ;
         DROP ;
         SWAP ;
         DROP ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         CAR ;
         DIG 3 ;
         DUP ;
         DUG 4 ;
         CDR ;
         CAR ;
         SENDER ;
         PAIR ;
         SELF_ADDRESS ;
         DIG 4 ;
         DIG 2 ;
         UNPAIR ;
         NIL (pair nat nat) ;
         DIG 2 ;
         DIG 3 ;
         SIZE ;
         MUL ;
         DIG 4 ;
         DUP ;
         DUG 5 ;
         CDR ;
         PAIR ;
         CONS ;
         DIG 3 ;
         CAR ;
         PAIR ;
         SWAP ;
         PUSH address "KT19ovJhcsUn4YU8Q5L3BGovKSixfbWcecEA" ;
         DIG 2 ;
         DUP ;
         DUG 3 ;
         CAR ;
         COMPARE ;
         EQ ;
         IF { SWAP ;
              DUP ;
              DUG 2 ;
              CDR ;
              MAP { SWAP ; DUP ; DUG 2 ; PAIR } ;
              SWAP ;
              DROP ;
              SWAP ;
              CAR ;
              DIG 5 ;
              SWAP ;
              EXEC ;
              PUSH mutez 0 ;
              NIL (pair address (list (pair address (pair nat nat)))) ;
              DIG 3 ;
              DIG 4 ;
              PAIR ;
              CONS ;
              TRANSFER_TOKENS }
            { DROP 3 ; DIG 2 ; DROP ; PUSH string "WRONG_CONTRACT" ; FAILWITH } ;
         CONS ;
         PAIR } }
