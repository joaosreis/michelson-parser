{ parameter
    (or (or (or (pair %addRemoveFarm address bool) (address %changeAdmin))
            (or (nat %changeCommission)
                (pair %getReferralInfo
                   (contract %contr
                      (pair (address %sender)
                            (pair (address %receiver) (pair (address %referrer) (nat %commission)))))
                   (pair (address %receiver) (address %sender)))))
        (pair %setReferrer address address)) ;
  storage
    (pair (big_map %ledger address (pair (address %addr) (nat %referred_count)))
          (pair (big_map %referrers address address)
                (pair (set %farms address) (pair (nat %commission) (address %admin))))) ;
  code { DUP ;
         CDR ;
         SWAP ;
         CAR ;
         IF_LEFT
           { IF_LEFT
               { IF_LEFT
                   { DUP ;
                     CDR ;
                     SWAP ;
                     CAR ;
                     DIG 2 ;
                     DUP ;
                     DUG 3 ;
                     CDR ;
                     CDR ;
                     CDR ;
                     CDR ;
                     SENDER ;
                     COMPARE ;
                     NEQ ;
                     IF { DROP 2 ; PUSH string "ReferralSystem/not-admin" ; FAILWITH }
                        { SWAP ;
                          IF { SWAP ;
                               DUP ;
                               DUG 2 ;
                               CDR ;
                               CDR ;
                               CDR ;
                               DIG 2 ;
                               DUP ;
                               DUG 3 ;
                               CDR ;
                               CDR ;
                               CAR ;
                               DIG 2 ;
                               PUSH bool True ;
                               SWAP ;
                               UPDATE ;
                               PAIR ;
                               SWAP ;
                               DUP ;
                               DUG 2 ;
                               CDR ;
                               CAR ;
                               PAIR ;
                               SWAP ;
                               CAR ;
                               PAIR }
                             { SWAP ;
                               DUP ;
                               DUG 2 ;
                               CDR ;
                               CDR ;
                               CDR ;
                               DIG 2 ;
                               DUP ;
                               DUG 3 ;
                               CDR ;
                               CDR ;
                               CAR ;
                               DIG 2 ;
                               PUSH bool False ;
                               SWAP ;
                               UPDATE ;
                               PAIR ;
                               SWAP ;
                               DUP ;
                               DUG 2 ;
                               CDR ;
                               CAR ;
                               PAIR ;
                               SWAP ;
                               CAR ;
                               PAIR } } ;
                     NIL operation ;
                     PAIR }
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CDR ;
                     CDR ;
                     CDR ;
                     SENDER ;
                     COMPARE ;
                     NEQ ;
                     IF { DROP ; PUSH string "ReferralSystem/not-admin" ; FAILWITH }
                        { SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CDR ;
                          CDR ;
                          CAR ;
                          PAIR ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CDR ;
                          CAR ;
                          PAIR ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CAR ;
                          PAIR ;
                          SWAP ;
                          CAR ;
                          PAIR } ;
                     NIL operation ;
                     PAIR } }
               { IF_LEFT
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CDR ;
                     CDR ;
                     CDR ;
                     SENDER ;
                     COMPARE ;
                     NEQ ;
                     IF { DROP ; PUSH string "ReferralSystem/not-admin" ; FAILWITH }
                        { PUSH nat 100 ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          COMPARE ;
                          GT ;
                          IF { DROP ; PUSH string "ReferralSystem/too-high-commission" ; FAILWITH }
                             { SWAP ;
                               DUP ;
                               DUG 2 ;
                               CDR ;
                               CDR ;
                               CDR ;
                               CDR ;
                               SWAP ;
                               PAIR ;
                               SWAP ;
                               DUP ;
                               DUG 2 ;
                               CDR ;
                               CDR ;
                               CAR ;
                               PAIR ;
                               SWAP ;
                               DUP ;
                               DUG 2 ;
                               CDR ;
                               CAR ;
                               PAIR ;
                               SWAP ;
                               CAR ;
                               PAIR } } ;
                     NIL operation ;
                     PAIR }
                   { SWAP ;
                     DUP ;
                     DUG 2 ;
                     CDR ;
                     CDR ;
                     CAR ;
                     SENDER ;
                     MEM ;
                     IF { SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CAR ;
                          SWAP ;
                          DUP ;
                          DUG 2 ;
                          CDR ;
                          CDR ;
                          GET ;
                          IF_NONE { PUSH string "ReferralSystem/referrer-not-found" ; FAILWITH } {} ;
                          NIL operation ;
                          DIG 2 ;
                          DUP ;
                          DUG 3 ;
                          CAR ;
                          PUSH mutez 0 ;
                          DIG 5 ;
                          DUP ;
                          DUG 6 ;
                          CDR ;
                          CDR ;
                          CDR ;
                          CAR ;
                          DIG 4 ;
                          PAIR ;
                          DIG 4 ;
                          DUP ;
                          DUG 5 ;
                          CDR ;
                          CAR ;
                          PAIR ;
                          DIG 4 ;
                          CDR ;
                          CDR ;
                          PAIR ;
                          TRANSFER_TOKENS ;
                          CONS }
                        { DROP ; PUSH string "ReferralSystem/sender-is-not-farm" ; FAILWITH } ;
                     PAIR } } }
           { DUP ;
             CDR ;
             SWAP ;
             CAR ;
             DIG 2 ;
             DUP ;
             DUG 3 ;
             CDR ;
             CDR ;
             CAR ;
             SENDER ;
             MEM ;
             IF { DUP ;
                  DIG 2 ;
                  DUP ;
                  DUG 3 ;
                  COMPARE ;
                  EQ ;
                  IF { PUSH string "ReferralSystem/can-not-refer-yourself" ; FAILWITH } {} ;
                  DIG 2 ;
                  DUP ;
                  DUG 3 ;
                  CDR ;
                  CAR ;
                  SWAP ;
                  DUP ;
                  DUG 2 ;
                  GET ;
                  IF_NONE
                    { DIG 2 ;
                      DUP ;
                      DUG 3 ;
                      DIG 2 ;
                      DUP ;
                      DUG 3 ;
                      SWAP ;
                      CAR ;
                      SWAP ;
                      DUP ;
                      DUG 2 ;
                      GET ;
                      IF_NONE { PUSH nat 0 ; SWAP ; PAIR } { SWAP ; DROP } ;
                      PUSH nat 1 ;
                      SWAP ;
                      DUP ;
                      DUG 2 ;
                      CDR ;
                      ADD ;
                      SWAP ;
                      CAR ;
                      PAIR ;
                      DIG 3 ;
                      DUP ;
                      DUG 4 ;
                      CDR ;
                      DIG 4 ;
                      CAR ;
                      DIG 2 ;
                      DIG 4 ;
                      DUP ;
                      DUG 5 ;
                      SWAP ;
                      SOME ;
                      SWAP ;
                      UPDATE ;
                      PAIR ;
                      DUP ;
                      CDR ;
                      CDR ;
                      SWAP ;
                      DUP ;
                      DUG 2 ;
                      CDR ;
                      CAR ;
                      DIG 4 ;
                      DIG 4 ;
                      SWAP ;
                      SOME ;
                      SWAP ;
                      UPDATE ;
                      PAIR ;
                      SWAP ;
                      CAR ;
                      PAIR }
                    { DROP 3 } }
                { DROP 2 ; PUSH string "ReferralSystem/sender-is-not-farm" ; FAILWITH } ;
             NIL operation ;
             PAIR } } }
