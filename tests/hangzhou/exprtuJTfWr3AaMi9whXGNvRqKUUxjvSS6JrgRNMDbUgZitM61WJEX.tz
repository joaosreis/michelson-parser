{ parameter
    (or (unit %default)
        (pair %command
           (or :action
              (pair :transfer (mutez %amount) (contract %dest unit))
              (or (option %delegate key_hash) (key %new_key)))
           signature)) ;
  storage (pair (pair (nat %counter) (key %key)) (mutez %balance)) ;
  code { UNPAIR ;
         IF_LEFT
           { DROP ;
             PUSH (set address) { "tz1eBSEX4KZ7dT7XrDxUX4HtXZBsb8XgPV7o" } ;
             SENDER ;
             MEM ;
             { IF {} { { UNIT ; FAILWITH } } } ;
             UNPAIR @counter_key @balance ;
             SWAP ;
             AMOUNT ;
             ADD @new_balance ;
             SWAP ;
             PAIR ;
             NIL operation ;
             PAIR }
           { AMOUNT ;
             PUSH mutez 0 ;
             { { COMPARE ; EQ } ; IF {} { { UNIT ; FAILWITH } } } ;
             UNPAIR @action @signature ;
             DIG 2 ;
             UNPAIR @counter_key @balance ;
             UNPAIR @counter @key ;
             DIG 2 ;
             DUG 4 ;
             DUP ;
             DUP 4 ;
             PAIR ;
             SENDER ;
             SELF ;
             ADDRESS ;
             PAIR ;
             CHAIN_ID ;
             PAIR ;
             PAIR ;
             PACK ;
             DIG 4 ;
             DUP 4 ;
             CHECK_SIGNATURE ;
             { IF {} { { UNIT ; FAILWITH } } } ;
             PUSH nat 1 ;
             ADD @new_counter ;
             PAIR @new_storage ;
             SWAP ;
             NIL operation ;
             SWAP ;
             IF_LEFT
               { NOW ;
                 PUSH timestamp "2024-12-23T23:00:00Z" ;
                 SUB @rem_sec ;
                 PUSH @month int 2629800 ;
                 SWAP ;
                 EDIV ;
                 { IF_NONE { { UNIT ; FAILWITH } } {} } ;
                 CAR @rem_month_round_down ;
                 PUSH int 1 ;
                 ADD @rem_month_round_up ;
                 ISNAT ;
                 { IF_NONE { PUSH nat 0 } {} } ;
                 PUSH @monthly_amount mutez 10000 ;
                 MUL @amount_that_must_remain ;
                 DUP 2 ;
                 CAR @amount ;
                 DIG 5 ;
                 SUB @balance_after ;
                 DUP ;
                 DUG 5 ;
                 SUB ;
                 DROP ;
                 UNPAIR ;
                 UNIT ;
                 TRANSFER_TOKENS ;
                 CONS }
               { IF_LEFT { SET_DELEGATE ; CONS } { DIG 2 ; CAR ; PAIR ; SWAP } } ;
             DIP { PAIR } ;
             PAIR } } }
