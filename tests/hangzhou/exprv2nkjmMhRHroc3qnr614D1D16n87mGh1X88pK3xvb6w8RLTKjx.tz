{ parameter
    (or (pair %deposit
           (pair (nat %amount_to_transfer) (contract %callback (ticket bytes)))
           (contract %fa12_transfer (pair address (pair address nat))))
        (ticket %withdraw bytes)) ;
  storage unit ;
  code { CAR ;
         PUSH unit Unit ;
         SWAP ;
         IF_LEFT
           { DUP ;
             CAR ;
             CDR ;
             PUSH mutez 0 ;
             DUP 3 ;
             CAR ;
             CAR ;
             DUP 4 ;
             CDR ;
             ADDRESS ;
             PACK ;
             TICKET ;
             TRANSFER_TOKENS ;
             NIL operation ;
             SWAP ;
             CONS ;
             SWAP ;
             DUP ;
             DUG 2 ;
             CAR ;
             CAR ;
             DIG 2 ;
             CDR ;
             PUSH mutez 0 ;
             DIG 2 ;
             SELF_ADDRESS ;
             PAIR ;
             SOURCE ;
             PAIR ;
             TRANSFER_TOKENS ;
             CONS }
           { READ_TICKET ;
             SWAP ;
             DROP ;
             UNPAIR ;
             SWAP ;
             UNPAIR ;
             SELF_ADDRESS ;
             DIG 3 ;
             COMPARE ;
             EQ ;
             PUSH string "We only accept tickets we created!" ;
             SWAP ;
             NOT ;
             IF { FAILWITH } { DROP } ;
             UNPACK address ;
             IF_NONE
               { PUSH string "The ticket somehow did not contain a valid address" ;
                 FAILWITH }
               {} ;
             CONTRACT %transfer (pair address (pair address nat)) ;
             IF_NONE
               { PUSH string "The contract does not exist or is not a valid fa1.2 contract" ;
                 FAILWITH }
               {} ;
             PUSH mutez 0 ;
             DIG 2 ;
             SOURCE ;
             PAIR ;
             SELF_ADDRESS ;
             PAIR ;
             TRANSFER_TOKENS ;
             NIL operation ;
             SWAP ;
             CONS } ;
         PAIR } }
